# 万濮云 (SweaterCraft Pro) 项目进度总结

### 1. 项目概况
- **类型**：针织毛衫开发全生命周期管理系统 (SaaS)。
- **技术栈**：Next.js 15 (App Router), Prisma ORM, SQLite, Tailwind CSS 4, Lucide Icons。
- **环境配置**：已优化 Server Actions 传输限制至 100MB，适配大附件上传。

### 2. 已完成核心功能
- **款式管理 (Product)**：
    - 全面 CRUD：支持录入、编辑、归档、彻底删除。
    - **安全删除**：仅允许删除未正式开始开发（除首个节点允许为“进行中”外，其余所有节点必须为“待开始”）的款式。
    - **智能录入**：新增款式时自动记忆上一个产品的字段名（如针型、成分等），提升效率。
- **多租户架构 (Multi-tenancy)**：
    - **数据隔离**：已在本地数据库中通过 `tenantId` (即公司名) 实现数据隔离。
    - **智能切换**：根据连接的生产系统公司名自动过滤本地显示的款式和节点模板。
- **样品轮次 (Sample Versions)**：
    - 支持头样、二样、大货样等多轮次管理，数据完全隔离。
- **节点开发记录 (Stage Management)**：
    - **状态流转**：支持待开始、进行中、已完成、异常四种状态，具备自动顺序流转逻辑。
    - **核心工艺登记**：支持动态工艺参数名记忆，自动带出相同节点名称的历史参数名。
    - **交互优化**：支持忘记点“+”号时自动合并输入内容保存；时间轴自动过滤显示空值参数。
    - **附件系统**：支持图片、PDF、压缩包 (.zip/.rar) 上传。采用 Base64 持久化存储，支持在线预览与一键下载。
- **侧边栏与筛选**：
    - 模糊搜索 + 状态 Tab 切换。
    - **高级筛选**：支持按同步状态、当前停滞节点进行组合筛选，并实时反馈筛选标签。
- **云端发布**：
    - 已全面迁移至 **阿里云 ECS** (Ubuntu 24.04, 2核 4G)。
    - **部署架构**：采用 Docker + Docker Compose 容器化部署。
    - **持久化方案**：通过 Docker Volumes 挂载宿主机 `/root/wanpuyun/prisma/dev.db` 实现 SQLite 数据持久化。
    - **优化配置**：配置了 4GB Swap 虚拟内存，确保 Next.js 编译稳定性；更换了阿里云内部 Debian 软件源及 npm 镜像源，提升构建速度。
    - **运维脚本**：编写了 `update.sh` 一键拉取代码并自动构建重启。

### 3. 核心文件结构
- `app/actions.ts`: 封装所有服务端操作逻辑 (Server Actions)，包含深度定制的外部系统同步逻辑。
- `app/page.tsx`: 仪表盘状态中心，负责数据分发与 Modal 控制。
- `prisma/schema.prisma`: 核心模型定义，已优化 `tenantId` 索引与唯一性约束。
- `components/modals/`: 包含录入、节点登记、日志等核心交互组件。

### 4. 外部生产管理系统集成 (最新突破)
- **连接机制**：支持通过公司名、用户名、密码登录外部系统 (`www.wanpuxx.com`)，自动管理 Session Cookie 并支持**登录后自动刷新**。
- **字典获取**：自动从外部系统抓取颜色、尺码、原料（毛料/辅料）的完整字典数据（支持 1000+ 条）。
- **商品同步 (Generate Bulk Info)**：
    - **表单结构攻克**：已完美适配外部系统严格的 Yii2 表单验证，使用特定的 `uploadAlbumFiles[]` 和 `productAttrColorMaterials` 结构。
    - **图片同步**：支持本地款式图片自动上传并关联至外部系统相册。
    - **重量同步**：按照用户需求，原料用量和参考重量直接同步原始数值，不再进行单位换算。
    - **属性映射**：颜色标记为 `color` 类型，尺码标记为 `size` 类型，使用时间戳模拟唯一 ID。
- **UI/UX 优化**：
    - 颜色、尺码、原料采用**弹窗式选择器**，支持搜索、多选及直接新增字典项。
    - 布局紧凑，字体加深，提升高分辨率屏幕下的易读性。

### 5. 待办事项
1. **SSL 证书配置**：为阿里云 IP 绑定域名并配置 HTTPS (Nginx)。
2. **自动备份机制**：建立 `dev.db` 数据库文件的每日自动备份脚本。
3. **数据导出功能**：计划开发一键生成正式工艺单的 PDF 导出功能。
4. **性能监控**：定期检查 ECS 磁盘空间（由于附件采用 Base64 存储，数据库体积增长可能较快）。
